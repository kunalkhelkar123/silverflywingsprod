
import { NextResponse } from "next/server";
import db from "../../../configs/db"

export const POST = async (request) => {
    let connection;

    try {

        const { username, password } = req.body

        if (!username || !password) {
            res.status(400).json({ message: 'Username and password are required' })
        }

        const sqlCheckUser = 'SELECT * FROM users_master WHERE email = ?'

        const sqlCreateUser =
            'INSERT INTO users_master (email, password) VALUES (?, ?)'

        try {
            const [rows] = await db.execute(sqlCheckUser, [username])
            if (rows.length > 0) {
                res.status(409).json({ message: 'Username already exists' })
            } else {
                const salt = await bcrypt.genSalt(10)
                const hashedPassword = await bcrypt.hash(password, salt)
                const [rows] = await db.execute(sqlCreateUser, [username, hashedPassword])
                const accessToken = jwt.sign({ id: rows.insertId }, process.env.NEXT_PUBLIC_JWT_SECRET)

                res.status(200).json({ accessToken })
            }
        } catch (error) {
            console.log('error', error.message)
            res.status(500).json({ message: error.message })
        }



    } catch (error) {
        console.error("Error during login process:", error);
        return NextResponse.json({ message: "Something went wrong." }, { status: 500 });
    } finally {
        if (connection) {
            try {
                await connection.end();
                console.log("Database connection closed.");
            } catch (error) {
                console.error("Error closing the database connection:", error);
            }
        }
    }
};
































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































